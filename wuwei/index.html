<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>五维风格 + 脸型 报告生成器</title>
  <!-- 依赖库：导出图片、读表格、打包压缩、CSV 解析 -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    html, body { height:100%; margin:0; font-family:"Microsoft YaHei", sans-serif; background:#f5f5f5; overflow:hidden; }

    /* 顶部操作条：与你第一个页面一致的绿色按钮风格 */
    .toolbar{ position:fixed; top:0; left:40%; transform:translateX(-33%); background:#fff; border-bottom:1px solid #ddd; padding:10px; display:flex; gap:8px; z-index:1000; }
    .toolbar button, .toolbar label{ padding:8px 16px; min-width:120px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer; text-align:center; }
    .toolbar button:hover, .toolbar label:hover{ background:#218838; }
    .toolbar input[type=file]{ display:none; }

    /* 舞台：整张图自适应一屏且保持比例；输入框百分比定位，随尺寸等比变换 */
    #stageWrap{ height:100%; display:flex; justify-content:center; align-items:center; }
    #stage{ position:relative; /* 宽高由 JS 计算设置 */ --h:1000px; }
    #bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:block; }
    #fields{ position:absolute; inset:0; }

    .field{ position:absolute; color:#000; background:transparent; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; font-size: calc(2px + var(--h) * 0.02);}

    /* —— 按百分比(相对整图)布点，可微调 —— */
    .class    { top:34.4%; left:31.0%; width:62%; }
    .name     { top:39.8%; left:31.0%; width:62%; }
    .contour  { top:45.4%; left:52.5%; width:43%; }
    .volume   { top:50.9%; left:52.5%; width:43%; }
    .ratio    { top:56.2%; left:52.5%; width:43%; }
    .eyes     { top:61.8%; left:52.5%; width:43%; }
    .texture  { top:67.2%; left:52.5%; width:43%; }
    .keywords { top:72.7%; left:45.0%; width:52%; }

    /* 右侧缩略图区域（用于单个预览后右键复制） */
    #thumbPanel{ position:fixed; right:16px; top:84px; width:220px; z-index:900; text-align:center; color:#555; }
    #thumb{ max-width:100%; border:1px solid #ccc; border-radius:8px; display:none; }

    /* 进度条 */
    .progress{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#fff; color:#333; padding:12px 16px; border-radius:12px; display:none; z-index:1100; box-shadow:0 6px 20px rgba(0,0,0,.12); min-width:320px; }
    .progress .title{ font-weight:700; margin-bottom:6px; }
    .progress .bar{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .progress .bar > div{ height:100%; width:0%; background:linear-gradient(90deg,#7c3aed,#a855f7); border-radius:999px; transition:width .18s; }
    .progress .desc{ margin-top:6px; color:#666; }
  </style>
</head>
<body>
  <!-- 操作条 -->
  <div class="toolbar">
    <button id="btnTplXlsx">下载模版表格</button>
    <label for="dataFile">上传模版文件</label><input id="dataFile" type="file" accept=".xlsx,.xls,.csv" />
    <button id="btnBatch">开始批量生成</button>
    <button id="btnSingle">生成单个（预览）</button>
  </div>

  <!-- 单个预览缩略图（右键复制/保存） -->
  <div id="thumbPanel">
    <div style="font-size:13px;margin-bottom:6px;">单个生成缩略图（右键复制/保存）</div>
    <img id="thumb" alt="预览缩略图" />
  </div>

  <!-- 一屏自适应舞台 -->
  <div id="stageWrap">
    <div id="stage">
      <img id="bg" src="五维风格报告.png" alt="背景" />
      <div id="fields">
        <div class="field class"     id="class"     contenteditable="true">班级</div>
        <div class="field name"      id="name"      contenteditable="true">姓名</div>
        <div class="field contour"   id="contour"   contenteditable="true">直中曲</div>
        <div class="field volume"    id="volume"    contenteditable="true">大中小</div>
        <div class="field ratio"     id="ratio"     contenteditable="true">动中静</div>
        <div class="field eyes"      id="eyes"      contenteditable="true">紧中松</div>
        <div class="field texture"   id="texture"   contenteditable="true">粗中细</div>
        <div class="field keywords"  id="keywords"  contenteditable="true">风格关键词</div>
      </div>
    </div>
  </div>

  <!-- 批量进度提示 -->
  <div id="prog" class="progress">
    <div class="title">批量生成进度</div>
    <div class="bar"><div id="progFill"></div></div>
    <div class="desc" id="progText">准备开始…</div>
  </div>

  <script>
    // ============ 让整图自适应一屏，且为输入框等比缩放提供高度变量 --h ============
    (function(){
      const stage = document.getElementById('stage');
      const img   = document.getElementById('bg');
      function layout(){
        const vw = window.innerWidth, vh = window.innerHeight;
        const iw = img.naturalWidth  || img.width;
        const ih = img.naturalHeight || img.height;
        if(!iw || !ih) return;
        const scale = Math.min(vw/iw, (vh-80)/ih); // 扣掉顶部工具条高度余量
        const w = Math.floor(iw*scale), h = Math.floor(ih*scale);
        stage.style.width = w+'px';
        stage.style.height= h+'px';
        stage.style.setProperty('--h', h+'px');
      }
      img.onload = layout; window.addEventListener('resize', layout); if(img.complete) layout();
    })();

    // ============ 下载 Excel 模版 ============
    document.getElementById('btnTplXlsx').addEventListener('click', ()=>{
      const headers = [[
        '班级','姓名','轮廓（直中曲）','量感（大中小）','比例（动中静）','眼神（紧中松）','质感（粗中细）','风格关键词'
      ]];
      const ws = XLSX.utils.aoa_to_sheet(headers);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '模板');
      const buf = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), '五维风格名单模版.xlsx');
    });

    // ============ 读取 CSV/Excel 数据 ============
    let dataRows = [];
    document.getElementById('dataFile').addEventListener('change', async (e)=>{
      try{
        const f = e.target.files[0]; if(!f) return;
        const name = f.name.toLowerCase();
        if(name.endsWith('.csv')){
          const text = await f.text();
          const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
          dataRows = parsed.data;
        }else if(name.endsWith('.xlsx') || name.endsWith('.xls')){
          const buf = await f.arrayBuffer();
          const wb  = XLSX.read(buf, {type:'array'});
          const sheet = wb.Sheets[wb.SheetNames[0]];
          dataRows = XLSX.utils.sheet_to_json(sheet);
        }else{ alert('请上传 .csv / .xlsx / .xls 文件'); return; }
        alert('已读取 '+ dataRows.length +' 行数据');
      }catch(err){ alert('读取失败：'+ err.message); }
    });

    // ============ 渲染为 Canvas（解决跨域污染） ============
    async function ensureSafeImageURL(imgEl){
      let s = imgEl && imgEl.src ? imgEl.src : '';
      if(!s) throw new Error('尚未选择模板图片。');
      if(s.startsWith('blob:') || s.startsWith('data:') || s.endsWith('五维风格报告.png')) return s;
      return await new Promise((resolve, reject)=>{
        const t = new Image(); t.crossOrigin='anonymous';
        t.onload = ()=>{
          try{ const c=document.createElement('canvas'); c.width=t.naturalWidth||t.width; c.height=t.naturalHeight||t.height; c.getContext('2d').drawImage(t,0,0); resolve(c.toDataURL('image/png')); }
          catch(e){ reject(e); }
        };
        t.onerror = ()=>reject(new Error('模板图片无法转为安全来源。'));
        t.src = s;
      });
    }

    async function renderToCanvas(){
      const safeURL = await ensureSafeImageURL(document.getElementById('bg'));
      const target = document.getElementById('stage');
      const canvas = await html2canvas(target,{
        scale:2, useCORS:true, allowTaint:false, backgroundColor:null,
        onclone:(doc)=>{ const cloneImg = doc.getElementById('bg'); if(cloneImg) cloneImg.src = safeURL; }
      });
      return canvas;
    }

    // ============ 单个预览（右侧缩略图） ============
    document.getElementById('btnSingle').addEventListener('click', async ()=>{
      try{
        const canvas = await renderToCanvas();
        const dataURL = canvas.toDataURL('image/png');
        const el = document.getElementById('thumb');
        el.src = dataURL; el.style.display='block';
      }catch(e){ alert('生成失败：'+ e.message); }
    });

    // ============ 批量生成 ZIP ============
    document.getElementById('btnBatch').addEventListener('click', async ()=>{
      if(!dataRows.length){ alert('请先上传模版数据文件'); return; }
      try{ await ensureSafeImageURL(document.getElementById('bg')); }catch(e){ alert(e.message); return; }

      const panel = document.getElementById('prog');
      const fill  = document.getElementById('progFill');
      const text  = document.getElementById('progText');
      const setProgress = (p,msg)=>{ panel.style.display='block'; fill.style.width=Math.max(0,Math.min(100,p))+'%'; text.textContent=msg||''; };

      try{
        setProgress(2,'准备开始…');
        const zip = new JSZip();
        for(let i=0;i<dataRows.length;i++){
          const row = dataRows[i];
          setField('class',    row['班级']||'');
          setField('name',     row['姓名']||'');
          setField('contour',  row['轮廓（直中曲）']||'');
          setField('volume',   row['量感（大中小）']||'');
          setField('ratio',    row['比例（动中静）']||'');
          setField('eyes',     row['眼神（紧中松）']||'');
          setField('texture',  row['质感（粗中细）']||'');
          setField('keywords', row['风格关键词']||'');

          await new Promise(r=>requestAnimationFrame(r));
          const canvas = await renderToCanvas();
          const blob   = await new Promise(res=>canvas.toBlob(res));
          const filename = (row['姓名']||('report_'+(i+1))) + '.png';
          zip.file(filename, blob);

          const pct = Math.round(((i+1)/dataRows.length)*85);
          setProgress(pct, `渲染图片：${i+1}/${dataRows.length}`);
        }
        setProgress(92,'正在打包压缩…');
        const zipBlob = await zip.generateAsync({ type:'blob' }, (m)=>{
          const extra = Math.round((m.percent||0)*0.08);
          setProgress(92+extra, `压缩中… ${Math.round(m.percent||0)}%`);
        });
        setProgress(100,'完成，准备下载…');
        saveAs(zipBlob, '五维风格_批量报告.zip');
      }catch(err){ alert('生成出错：'+ (err?.message||err)); }
      finally{ setTimeout(()=>{ panel.style.display='none'; fill.style.width='0%'; text.textContent=''; }, 1200); }
    });

    function setField(id, v){ const el = document.getElementById(id); if(el) el.textContent = v; }
  </script>
</body>
</html>
